{% extends "base.html" %}

{% load session_filters %}

{% block extra-style %}
<style>
    .heart-white {
        color: white;
    }

    .heart-red {
        color: red;
    }

    .btn-sm {
        background-color: rgb(49, 49, 49);
        padding: auto;
        line-height: auto; /* 줄간격 조정 */
        height: auto; /* 버튼 높이 조정 */
        color: rgb(255, 255, 255);
    }

    .col-md-5{
        display: flex; 
        flex-direction: column; 
        justify-content: space-between;
    }

    .btn-outline-light {
        color: rgb(255, 255, 255); 
        background-color: none; 
        border: none;
        position: relative;
        display: flex;
        align-items: center; /* 세로 중앙 정렬 */
        justify-content: center; /* 가로 중앙 정렬 */
        width: 20px; /* 버튼 너비 설정 */
        height: 20px; /* 버튼 높이 설정 */
        margin-top: -20px;
    }

    .btn-outline-light-rm{
        color: rgb(255, 0, 0); /* 빨간색으로 변경 */
        background-color: transparent; 
        border: none;
        position: relative;
        display: flex;
        align-items: center; /* 세로 중앙 정렬 */
        justify-content: center; /* 가로 중앙 정렬 */
        width: 20px; /* 버튼 너비 설정 */
        height: 20px; /* 버튼 높이 설정 */
        margin-top: -20px;
    }
</style>
{% endblock extra-style %}

{% block content %}
<div class="container">
    <div class="row" style="border-radius: 20px;">
        <!-- Left column for the song image -->
        <div class="col-md-4 text-center" style="margin-left: 20%;">
            <img src="{{ song.thumbnail.url }}" alt="{{ song.title }}" class="img-fluid rounded" style="max-width: 100%; height: auto;">
        </div>

        <!-- Right column for the song details -->
        <div class="col-md-5">
            <h3 class="card-title" style="color: rgb(255, 255, 255); margin-bottom: 20px;">{{ song.title }}</h3>
            {% is_added_to_cart user song.id as added %}<!-- 찜한 목록에 있으면 -->
            {% if not added %}
            <button id="toggle-btn" class="btn btn-outline-light" onclick="toggleButtonColor()">🤍</button> <!-- 토글 버튼으로 변경 -->
            {% else %}
            <button id="toggle-btn" class="btn btn-outline-light-rm" onclick="toggleButtonColor()">❤️</button> <!-- 토글 버튼으로 변경 -->
            {% endif %}
            <button id="like-btn" class="btn btn-outline-primary" onclick="toggleLike()" style="color: white; width: calc(30%);">
                Like
            </button>
            <button type="button" class="btn btn-outline-danger" style="width: 30%;">Musician Follow</button>
            <div class="d-flex">
                <div class="me-4">
                    <h6 style="color: aliceblue;">Made by</h6>
                    <a href="{% url 'sellers:seller_detail' song.seller.id %}" class="btn btn-sm">{{ song.seller }}</a>
                </div>
                <div>
                    <h6 style="color: aliceblue;">장르</h6>
                    <p class="btn btn-sm" style="background-color: rgb(49, 49, 49);">{{ song.genre }}</p>
                </div>
                <div style="margin-left: 20px;">
                    <h6 style="color: aliceblue;">Tempo</h6>
                    <p class="btn btn-sm" style="background-color: rgb(49, 49, 49);">{{ song.display_tempo }}</p>
                </div>
                
            </div>
            <audio controls class="w-100" controlsList="nodownload">
                <source src="{% url 'songs:song_stream' song.id %}" type="audio/mpeg">
                Your browser does not support the audio element.
            </audio>
        </div>
    </div>
    <!-- Comments section -->
    <div class="card my-4" style="background-color: rgb(20, 20, 20); border:none">
        <hr style="border-top: 1px solid white;">
        <h5 class="card-header" style="color: aliceblue;">Comments:</h5>
        <hr style="border-top: 1px solid white;">
        <div class="card-body">
            <form>
                <div class="mb-3">
                    <textarea class="form-control" rows="3" style="background-color: rgb(46, 46, 46);"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">작성완료</button>
            </form>
        </div>
    </div>
</div>
{% endblock content %}


{% block extra-script %}
<script>
    // 버튼을 클릭했을 때 찜 목록에 추가 또는 제거하는 함수
    function toggleButtonColor() {
        const btn = document.getElementById('toggle-btn');
        const added = btn.classList.contains('btn-outline-light-rm'); // 빨간색 하트인지 확인

        if (added) {
            removeFromCart(); // 찜 목록에서 제거
        } else {
            addToCart(); // 찜 목록에 추가
        }
    }

    // 찜 목록에 노래를 추가하는 함수
    function addToCart() {
        const addBtn = document.getElementById('toggle-btn');
        axios({
            method: 'get',
            url: '{% url "carts:add_song" %}',
            params: {
                songid: '{{ song.id }}'
            }
        })
            .then(response => {
                addBtn.classList.remove('btn-outline-light');
                addBtn.classList.add('btn-outline-light-rm');
                addBtn.textContent = '❤️';
                alert('찜 목록에 "{{ song.title }}"을(를) 추가하였습니다.');
            })
            .catch(error => console.log(error));
    }

    // 찜 목록에서 노래를 제거하는 함수
    function removeFromCart() {
        const removeBtn = document.getElementById('toggle-btn');
        axios({
            method: 'get',
            url: '{% url "carts:remove_song" %}',
            params: {
                songid: '{{ song.id }}'
            }
        })
            .then(response => {
                removeBtn.classList.remove('btn-outline-light-rm');
                removeBtn.classList.add('btn-outline-light');
                removeBtn.textContent = '🤍';
                alert(response.data.success);
            })
            .catch(error => console.log(error));
    }

    // 좋아요 버튼을 토글하는 함수
    function toggleLike() {
        const likeBtn = document.getElementById('like-btn');
        const liked = likeBtn.classList.contains('liked'); // 이미 좋아요를 눌렀는지 확인

        if (liked) {
            dislike(); // 좋아요 취소
        } else {
            like(); // 좋아요
        }
    }

        // 좋아요 버튼을 누를 때의 동작
    function like() {
        const likeBtn = document.getElementById('like-btn');
        likeBtn.textContent = 'Liked!';
        likeBtn.style.backgroundColor = '#007bff'; // primary 색상으로 내부 색상 변경
        likeBtn.style.color = '#ffffff'; // 텍스트 색상을 흰색으로 변경
        likeBtn.style.borderColor = '#007bff'; // 테두리 색상을 primary로 유지
        likeBtn.classList.add('liked'); // 좋아요 상태로 클래스 추가
    }

    function dislike() {
        const likeBtn = document.getElementById('like-btn');
        likeBtn.textContent = 'Like';
        likeBtn.style.backgroundColor = ''; // 내부 색상 초기화
        likeBtn.style.color = ''; // 텍스트 색상 초기화
        likeBtn.style.borderColor = ''; // 테두리 색상 초기화
        likeBtn.classList.remove('liked'); // 좋아요 상태 클래스 제거
    }
</script>
{% endblock extra-script %}
